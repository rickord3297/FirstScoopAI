// Replace this in your script section:

// News API key - replace with your actual key
const NEWS_API_KEY = 'YOUR_NEWS_API_KEY';  // You need a valid API key from newsapi.org

// Modify the fetchAndDisplayArticles function to handle CORS issues and valid parameters
const fetchAndDisplayArticles = async (selectedTopic) => {
    loadingIndicator.classList.remove('hidden');
    errorContainer.classList.add('hidden');
    articlePreviewsContainer.innerHTML = ''; // Clear previous articles

    let apiUrl = '';
    let topicName = '';
    
    // For free plan, you need to use a proxy server or backend API
    // This won't work directly in the browser due to CORS restrictions
    const baseUrl = 'https://newsapi.org/v2/';
    
    switch (selectedTopic) {
        case 'ai':
            apiUrl = `${baseUrl}everything?q=artificial%20intelligence%20OR%20AI&sortBy=publishedAt&apiKey=${NEWS_API_KEY}`;
            // Don't use the sources parameter as it may have invalid IDs
            topicName = "Artificial Intelligence";
            break;
        case 'mac':
            apiUrl = `${baseUrl}everything?q=macbook%20OR%20imac%20OR%20apple&sortBy=publishedAt&apiKey=${NEWS_API_KEY}`;
            topicName = "Mac";
            break;
        case 'sports':
            apiUrl = `${baseUrl}top-headlines?country=us&category=sports&apiKey=${NEWS_API_KEY}`;
            topicName = "Sports";
            break;
        case 'all':
        default:
            apiUrl = `${baseUrl}top-headlines?country=us&apiKey=${NEWS_API_KEY}`;
            topicName = "All Topics";
            break;
    }

    try {
        console.log("Attempting to fetch from:", apiUrl); 
        
        // For demonstration purposes - this direct fetch WON'T work with the free plan
        // You need a backend proxy or server-side API to make this request
        const response = await fetch(apiUrl);
        
        if (!response.ok) {
            throw new Error(`Failed to fetch ${topicName} articles: ${response.status} - ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.status === 'error') {
            throw new Error(`News API Error: ${data.message}`);
        }

        if (data.articles && data.articles.length > 0) {
            data.articles.forEach(article => {
                try {
                    if (article && article.title) {  // Only process articles with at least a title
                        const articleElement = createArticleElement(article);
                        articlePreviewsContainer.appendChild(articleElement);
                    }
                } catch (e) {
                    console.error("Error creating article element:", e, article);
                }
            });
        } else {
            articlePreviewsContainer.innerHTML = `
                <div class="text-gray-500 dark:text-gray-400 py-8 text-center">
                    No articles found for ${topicName}.
                </div>`;
        }
    } catch (error) {
        errorContainer.classList.remove('hidden');
        errorMessageDisplay.textContent = error.message;
        
        // Add a more user-friendly message about CORS issues
        if (error.message.includes('Failed to fetch')) {
            errorMessageDisplay.textContent += 
                " This may be due to CORS restrictions. NewsAPI's free plan doesn't allow browser requests. Consider setting up a server-side proxy or using our demo data.";
            
            // Display demo data for demonstration purposes
            displayDemoArticles(selectedTopic);
        }
        
        console.error("Error fetching or processing articles:", error);
    } finally {
        loadingIndicator.classList.add('hidden');
    }
};

// Add a function to display demo data when the API can't be accessed
function displayDemoArticles(topic) {
    const demoArticles = {
        ai: [
            {
                title: "The Latest Advancements in ChatGPT Technology",
                description: "OpenAI has released a new version of ChatGPT with improved reasoning capabilities and reduced hallucinations.",
                urlToImage: "https://via.placeholder.com/400x200?text=AI+News",
                author: "Tech Reporter",
                source: { name: "Tech News" },
                content: "OpenAI's latest model shows significant improvements in reasoning tasks and demonstrates enhanced capabilities in mathematics and coding problems.\n\nResearchers attribute the improvements to new training methodologies and architectural changes in the model."
            },
            {
                title: "AI Regulation Framework Proposed by International Coalition",
                description: "A coalition of countries has proposed a new framework for regulating artificial intelligence development.",
                urlToImage: "https://via.placeholder.com/400x200?text=AI+Regulation",
                author: "Policy Expert",
                source: { name: "Global Tech Review" },
                content: "The proposed framework addresses concerns about AI safety while promoting innovation.\n\nKey provisions include mandatory transparency reports for large AI systems and ethical guidelines for AI development."
            }
        ],
        mac: [
            {
                title: "Apple Announces New MacBook Pro with M3 Pro and M3 Max Chips",
                description: "The latest MacBook Pro models feature improved performance and battery life with the new M3 series chips.",
                urlToImage: "https://via.placeholder.com/400x200?text=MacBook+Pro",
                author: "Apple Insider",
                source: { name: "Mac News" },
                content: "Apple's new MacBook Pro models show significant performance improvements over the previous generation.\n\nThe M3 Pro and M3 Max chips offer up to 40% faster CPU performance and improved GPU capabilities for professional workflows."
            },
            {
                title: "macOS Sequoia Features Leaked Ahead of WWDC",
                description: "Rumors suggest the next version of macOS will include major AI features and redesigned system applications.",
                urlToImage: "https://via.placeholder.com/400x200?text=macOS+News",
                author: "Mac Reporter",
                source: { name: "Apple Rumors" },
                content: "According to sources familiar with Apple's plans, macOS Sequoia will integrate AI capabilities across the system.\n\nThe update is expected to include a redesigned Finder app and enhanced collaboration features."
            }
        ],
        sports: [
            {
                title: "Lakers Win NBA Championship in Thrilling Game 7",
                description: "The Los Angeles Lakers defeated the Boston Celtics in a historic Game 7 to win their 18th NBA Championship.",
                urlToImage: "https://via.placeholder.com/400x200?text=NBA+Finals",
                author: "Sports Writer",
                source: { name: "Sports News" },
                content: "In a game that came down to the final seconds, the Lakers secured their record-breaking 18th championship.\n\nThe team's star player was named Finals MVP after averaging 32 points per game throughout the series."
            },
            {
                title: "Olympic Committee Announces New Sports for 2028 Games",
                description: "The 2028 Los Angeles Olympics will feature several new sports, including cricket and flag football.",
                urlToImage: "https://via.placeholder.com/400x200?text=Olympics+News",
                author: "Olympic Correspondent",
                source: { name: "Sports International" },
                content: "The addition of cricket and flag football is expected to broaden the appeal of the Olympics to new audiences.\n\nThe Los Angeles organizing committee has expressed excitement about showcasing these sports on the global stage."
            }
        ],
        all: [
            {
                title: "Global Climate Summit Reaches Historic Agreement",
                description: "World leaders have agreed to new emissions targets at the latest climate summit.",
                urlToImage: "https://via.placeholder.com/400x200?text=Climate+News",
                author: "Environmental Reporter",
                source: { name: "World News" },
                content: "The agreement includes commitments to reduce carbon emissions by 50% by 2035.\n\nDeveloping nations will receive financial support to transition to renewable energy sources."
            },
            {
                title: "SpaceX Successfully Launches First Crewed Mission to Mars",
                description: "The historic mission marks the first time humans have traveled to the red planet.",
                urlToImage: "https://via.placeholder.com/400x200?text=Space+Exploration",
                author: "Science Correspondent",
                source: { name: "Space News" },
                content: "The crew of four astronauts will conduct experiments and explore potential sites for a future Mars base.\n\nThe mission is expected to last approximately two years, including travel time and surface operations."
            }
        ]
    };

    // Use the appropriate demo data set based on the selected topic
    const articlesToDisplay = demoArticles[topic] || demoArticles.all;
    
    articlesToDisplay.forEach(article => {
        const articleElement = createArticleElement(article);
        articlePreviewsContainer.appendChild(articleElement);
    });
    
    // Add a note about using demo data
    const demoNote = document.createElement('div');
    demoNote.className = "text-center p-4 my-4 bg-yellow-100 text-yellow-800 rounded-lg";
    demoNote.innerHTML = "<strong>Note:</strong> Displaying demo data. To see real articles, you'll need a NewsAPI key and a server-side proxy.";
    articlePreviewsContainer.prepend(demoNote);
}

// Update the initialization code
document.addEventListener('DOMContentLoaded', () => {
    if (NEWS_API_KEY === 'YOUR_NEWS_API_KEY') {
        errorContainer.classList.remove('hidden');
        errorMessageDisplay.textContent = 'Please replace "YOUR_NEWS_API_KEY" with your actual News API key in the code. Note that NewsAPI\'s free plan requires server-side requests.';
        
        // Show demo data so the app is still functional
        displayDemoArticles('all');
        return;
    }
    fetchAndDisplayArticles(topicDropdown.value);
});
